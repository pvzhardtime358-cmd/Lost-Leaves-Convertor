<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PvZ2 RTON → JSON</title>
<style>
body { background:#121212;color:#fff;font-family:sans-serif;text-align:center }
.box { border:2px dashed #444;padding:30px;margin:40px auto;width:320px }
.success { color:#4ade80 }
.error { color:#f87171 }
</style>
</head>
<body>

<h1>PvZ2 RTON Decoder (REAL)</h1>
<p>Decodes real PvZ2 RTON files</p>

<div class="box">
<input type="file" id="file" accept=".rton">
<p id="status"></p>
</div>

<script>
class PvZ2RTON {
    constructor(buffer) {
        this.view = new DataView(buffer);
        this.offset = 0;
        this.decoder = new TextDecoder();
        this.strings = [];
    }

    u8(){ return this.view.getUint8(this.offset++); }
    u32(){ const v=this.view.getUint32(this.offset,true); this.offset+=4; return v; }

    readStringRaw() {
        const len = this.u32();
        const b = new Uint8Array(this.view.buffer,this.offset,len);
        this.offset += len;
        return this.decoder.decode(b);
    }

    decode() {
        const magic = String.fromCharCode(
            this.u8(),this.u8(),this.u8(),this.u8()
        );
        if (magic !== "RTON") throw new Error("Invalid RTON");

        this.u32(); // version

        /* ---- STRING TABLE ---- */
        const stringCount = this.u32();
        for (let i=0;i<stringCount;i++) {
            this.strings.push(this.readStringRaw());
        }

        return this.readElement();
    }

    readElement() {
        const type = this.u8();

        switch(type) {
            case 0x00: return null;
            case 0x01: return false;
            case 0x02: return true;
            case 0x03: return this.u32();
            case 0x04: {
                const f = this.view.getFloat32(this.offset,true);
                this.offset+=4;
                return f;
            }
            case 0x05: {
                const id = this.u32();
                return this.strings[id] ?? null;
            }
            case 0x06: {
                const c=this.u32(), a=[];
                for(let i=0;i<c;i++) a.push(this.readElement());
                return a;
            }
            case 0x07: {
                const c=this.u32(), o={};
                for(let i=0;i<c;i++){
                    const k=this.strings[this.u32()];
                    o[k]=this.readElement();
                }
                return o;
            }
            case 0x90: return this.readElement(); // comment
            case 0x91: return this.readElement(); // metadata
            case 0xFF: return null;
            default:
                throw new Error("Unknown type 0x"+type.toString(16));
        }
    }
}

document.getElementById("file").onchange = async e => {
    const s=document.getElementById("status");
    try {
        const buf = await e.target.files[0].arrayBuffer();
        const r = new PvZ2RTON(buf);
        const json = r.decode();
        const blob = new Blob([JSON.stringify(json,null,4)]);
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=e.target.files[0].name.replace(".rton",".json");
        a.click();
        s.textContent="✅ Decoded successfully";
        s.className="success";
    } catch(err) {
        s.textContent="❌ "+err.message;
        s.className="error";
    }
};
</script>
</body>
</html>