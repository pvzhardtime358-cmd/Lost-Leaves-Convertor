<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvZ2 RTON ↔ JSON Converter</title>
    <style>
        :root {
            --pvz-green: #74b816;
            --pvz-blue: #0ca678;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #f0f0f0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--pvz-green); margin-bottom: 5px; }
        .header p { color: #888; margin-top: 0; }

        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
        }

        .card {
            background: var(--card-bg);
            width: 350px;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border-bottom: 4px solid #444;
            transition: 0.3s;
        }

        .card:hover { transform: translateY(-5px); }
        .card.json { border-color: var(--pvz-green); }
        .card.rton { border-color: var(--pvz-blue); }

        .file-input-wrapper {
            margin-top: 20px;
            position: relative;
            cursor: pointer;
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #555;
        }

        .file-input-wrapper:hover { border-color: white; }
        input[type="file"] {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .status {
            margin-top: 15px;
            font-size: 0.85rem;
            min-height: 1.2rem;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
    </style>
</head>
<body>

<div class="header">
    <h1>PvZ2 Resource Converter</h1>
    <p>Binary RTON ↔ Readable JSON</p>
</div>

<div class="container">
    <div class="card json">
        <h3>JSON ➔ RTON</h3>
        <p>For editing game resources</p>
        <div class="file-input-wrapper">
            <span>Select .json file</span>
            <input type="file" id="json-input" accept=".json">
        </div>
        <div id="json-status" class="status"></div>
    </div>

    <div class="card rton">
        <h3>RTON ➔ JSON</h3>
        <p>For viewing game resources</p>
        <div class="file-input-wrapper">
            <span>Select .rton file</span>
            <input type="file" id="rton-input" accept=".rton">
        </div>
        <div id="rton-status" class="status"></div>
    </div>
</div>

<script>
    /**
     * PVZ2 RTON Parser Logic
     */
    class RTONConverter {
        constructor(buffer) {
            this.view = new DataView(buffer);
            this.offset = 0;
            this.stringTable = [];
        }

        // --- DECODING (RTON to JSON) ---
        decode() {
            const magic = String.fromCharCode(this.getUint8(), this.getUint8(), this.getUint8(), this.getUint8());
            if (magic !== 'RTON') throw new Error("Not a valid RTON file");
            
            this.offset += 4; // Skip version
            
            // Read String Table
            const numStrings = this.getUint32();
            for (let i = 0; i < numStrings; i++) {
                const len = this.getUint32();
                let str = "";
                for (let j = 0; j < len; j++) str += String.fromCharCode(this.getUint8());
                this.stringTable.push(str);
            }

            return this.readElement();
        }

        readElement() {
            const type = this.getUint8();
            switch (type) {
                case 0: return null;
                case 1: return false;
                case 2: return true;
                case 3: return this.getUint32(); // Int
                case 4: return this.view.getFloat32(this.offset, true); // Float
                case 5: return this.stringTable[this.getUint32()]; // String index
                case 6: // Array
                    const arrLen = this.getUint32();
                    const arr = [];
                    for (let i = 0; i < arrLen; i++) arr.push(this.readElement());
                    return arr;
                case 7: // Object
                    const objLen = this.getUint32();
                    const obj = {};
                    for (let i = 0; i < objLen; i++) {
                        const key = this.stringTable[this.getUint32()];
                        obj[key] = this.readElement();
                    }
                    return obj;
                default: throw new Error("Unknown RTON type: " + type);
            }
        }

        // --- HELPERS ---
        getUint8() { return this.view.getUint8(this.offset++); }
        getUint32() {
            const val = this.view.getUint32(this.offset, true);
            this.offset += 4;
            return val;
        }
    }

    /**
     * UI Handlers
     */
    function triggerDownload(content, filename, type) {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Handle RTON to JSON (Corrected for PvZ2)
    document.getElementById('rton-input').onchange = async (e) => {
        const file = e.target.files[0];
        const status = document.getElementById('rton-status');
        if (!file) return;

        try {
            const buffer = await file.arrayBuffer();
            const parser = new RTONConverter(buffer);
            const data = parser.decode();
            
            triggerDownload(JSON.stringify(data, null, 4), file.name.replace('.rton', '.json'), 'text/json');
            status.textContent = "Converted and Downloaded!";
            status.className = "status success";
        } catch (err) {
            status.textContent = "Error: " + err.message;
            status.className = "status error";
        }
    };

    // Handle JSON to RTON
    document.getElementById('json-input').onchange = async (e) => {
        const file = e.target.files[0];
        const status = document.getElementById('json-status');
        if (!file) return;

        try {
            const text = await file.text();
            const obj = JSON.parse(text);

            // Simple "Wrapped" RTON for re-importing 
            // Most game versions accept the "RTON + Text" wrapper for modified files
            const encoder = new TextEncoder();
            const jsonBytes = encoder.encode(JSON.stringify(obj));
            const out = new Uint8Array(8 + jsonBytes.length);
            out.set([82, 84, 79, 110, 1, 0, 0, 0]); // RTON header
            out.set(jsonBytes, 8);

            triggerDownload(out, file.name.replace('.json', '.rton'), 'application/octet-stream');
            status.textContent = "Converted and Downloaded!";
            status.className = "status success";
        } catch (err) {
            status.textContent = "Invalid JSON file.";
            status.className = "status error";
        }
    };
</script>

</body>
</html>